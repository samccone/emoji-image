<html>
  <script src="data_gen/color_hard_map.js"></script>
  <body>
  <canvas></canvas>
  <canvas></canvas>
  <video src="" width="400px" height="400px"></video>
  </body>
  <script>
    var ctx;
    var sprite, spriteCtx;

    function snip() {
      ctx.drawImage(vid, 0,0)
      process(50, ctx);
      process(8, ctx);
      requestAnimationFrame(snip);
    }

    function getIndex(x,y,width,d) {
      var index = (x + y * width) * 4;
      return [
        ~~(Math.min(31, Math.max(d[index] / 8, 0))),
        ~~(Math.min(31, Math.max(d[index+1] / 8, 0))),
        ~~(Math.min(31, Math.max(d[index+2] / 8, 0)))
      ]
    }

    function process(size, src) {
      size = size || 8;

      var a = src.getImageData(0,0,img.width, img.height);

      for(var x =0; x< img.width; x+=size) {
        for(var y =0; y< img.height; y+=size) {

          var index = getIndex(x,y, img.width, a.data)

          var coords = (goats[index[0]]
            [index[1]]
            [index[2]]
            ).split(",");


          ctx2.drawImage(sprite,
            coords[0] * 64,
            coords[1] * 64,
            64,
            64,
            x-size/2,
            y-size/2,
            size,
            size
          )
        }
      }
    }


    var sprite = new Image()
    var img = new Image()

    sprite.onload = function() {
      img.src= "lol.jpg"
      var spriteCanvas = document.createElement('canvas')
      spriteCanvas.setAttribute('width', sprite.width+'px')
      spriteCanvas.setAttribute('height', sprite.height+'px')
      spriteCtx = spriteCanvas.getContext('2d');
      spriteCtx.drawImage(sprite, 0, 0);
    }

    img.onload = function() {
      var canvas = document.getElementsByTagName('canvas')[0];
      canvas.setAttribute('width', img.width+'px')
      canvas.setAttribute('height', img.height+'px')
      var canvas2 = document.getElementsByTagName('canvas')[1];
      canvas2.setAttribute('width', img.width+'px')
      canvas2.setAttribute('height', img.height+'px')
      ctx = canvas.getContext('2d');
      ctx2 = canvas2.getContext('2d');

      ctx.drawImage(img, 0, 0);
      process(100, ctx);
      process(40, ctx);
      process(10, ctx);
      process(15, ctx);
      process(3, ctx);
    }

    sprite.src="data_gen/base.png"

    navigator.webkitGetUserMedia({video: true, audio: false}, function(stream){
      vid = document.querySelector("video");
      vid.src = window.URL.createObjectURL(stream);
      vid.play()
      requestAnimationFrame(snip)
    }, function(){})
  </script>
</html>
